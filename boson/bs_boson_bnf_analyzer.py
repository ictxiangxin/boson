"""
    Boson v0.8 - Grammar analyzer generator

        Author: ict
        Email:  ictxiangxin@hotmail.com
        Site:   https://github.com/ictxiangxin/boson

    This code was generated by boson python code generator.

         0: command_statement -> command element_list end
         1: derivation -> derivation_body
         2: derivation -> derivation_body grammar_tuple
         3: derivation_body -> element_list
         4: derivation_body -> null
         5: derivation_body -> ~
         6: derivation_list -> derivation
         7: derivation_list -> derivation_list or derivation
         8: element -> literal
         9: element -> name
        10: element_list -> element
        11: element_list -> element_list element
        12: grammar -> grammar statement
        13: grammar -> statement
        14: grammar_tuple -> bracket_l node_list bracket_r
        15: node_list -> node
        16: node_list -> node_list comma node
        17: reduction_statement -> name reduce derivation_list end
        18: start -> grammar
        19: statement -> command_statement
        20: statement -> reduction_statement
"""


class BosonGrammar:
    def __init__(self):
        self.__grammar_tree = None
        self.__error_index = None

    def get_grammar_tree(self):
        return self.__grammar_tree

    def set_grammar_tree(self, grammar_tree: tuple):
        self.__grammar_tree = grammar_tree

    grammar_tree = property(get_grammar_tree, set_grammar_tree)

    def get_error_index(self):
        return self.__error_index

    def set_error_index(self, error_index: int):
        self.__error_index = error_index

    error_index = property(get_error_index, set_error_index)


class BosonBNFAnalyzer:
    def __init__(self):
        self.__terminal_index = {
            'or': 0,
            'end': 1,
            'literal': 3,
            'reduce': 4,
            'command': 5,
            '$': 6,
            'null': 7,
            'name': 8,
            'node': 9,
            'comma': 10,
            'bracket_l': 2,
            'bracket_r': 11
        }
        self.__action_table = {
            0: {8: 's1', 5: 's5'},
            1: {4: 's8'},
            2: {6: 'a'},
            3: {8: 's1', 5: 's5', 6: 'r19'},
            4: {8: 'r21', 5: 'r21', 6: 'r21'},
            5: {8: 's10', 3: 's13'},
            6: {8: 'r20', 5: 'r20', 6: 'r20'},
            7: {8: 'r14', 5: 'r14', 6: 'r14'},
            8: {0: 'r6', 1: 'r6', 2: 'r6', 3: 's13', 7: 's16', 8: 's10'},
            9: {8: 'r13', 5: 'r13', 6: 'r13'},
            10: {0: 'r10', 1: 'r10', 2: 'r10', 3: 'r10', 8: 'r10'},
            11: {8: 's10', 1: 's20', 3: 's13'},
            12: {0: 'r11', 1: 'r11', 2: 'r11', 3: 'r11', 8: 'r11'},
            13: {0: 'r9', 1: 'r9', 2: 'r9', 3: 'r9', 8: 'r9'},
            14: {0: 'r2', 1: 'r2', 2: 's22'},
            15: {0: 'r4', 1: 'r4', 2: 'r4', 3: 's13', 8: 's10'},
            16: {0: 'r5', 1: 'r5', 2: 'r5'},
            17: {0: 'r7', 1: 'r7'},
            18: {0: 's23', 1: 's24'},
            19: {0: 'r12', 1: 'r12', 2: 'r12', 3: 'r12', 8: 'r12'},
            20: {8: 'r1', 5: 'r1', 6: 'r1'},
            21: {0: 'r3', 1: 'r3'},
            22: {9: 's26'},
            23: {0: 'r6', 1: 'r6', 2: 'r6', 3: 's13', 7: 's16', 8: 's10'},
            24: {8: 'r18', 5: 'r18', 6: 'r18'},
            25: {10: 's29', 11: 's28'},
            26: {10: 'r16', 11: 'r16'},
            27: {0: 'r8', 1: 'r8'},
            28: {0: 'r15', 1: 'r15'},
            29: {9: 's30'},
            30: {10: 'r17', 11: 'r17'}
        }
        self.__goto_table = {
            0: {9: 6, 2: 7, 11: 3, 4: 2, 5: 4},
            3: {9: 6, 2: 9, 5: 4},
            5: {10: 11, 3: 12},
            22: {8: 25},
            23: {0: 14, 1: 27, 10: 15, 3: 12},
            8: {0: 14, 1: 17, 10: 15, 3: 12, 7: 18},
            11: {3: 19},
            14: {6: 21},
            15: {3: 19}
        }
        self.__node_table = {
            0: ['@', 'p0', 'p1'],
            14: ['@', 'p1'],
            17: ['@', 'p0', 'p2'],
            16: ['@', 'p0', 'p2'],
            7: ['@', 'p0', 'p2']
        }
        self.__reduce_symbol_sum = [3, 1, 2, 1, 1, 0, 1, 3, 1, 1, 1, 2, 2, 1, 3, 1, 3, 4, 1, 1, 1]
        self.__reduce_to_non_terminal_index = [9, 1, 1, 0, 0, 0, 7, 7, 3, 3, 10, 10, 11, 11, 6, 8, 8, 5, 4, 2, 2]

    def grammar_analysis(self, token_list):
        grammar = BosonGrammar()
        analysis_stack = [0]
        symbol_stack = []
        token_index = 0
        while token_index < len(token_list):
            token = token_list[token_index]
            current_state = analysis_stack[-1]
            operation = self.__action_table.get(current_state, {}).get(self.__terminal_index[token.symbol], 'e')
            operation_flag = operation[0]
            if operation_flag == 'e':
                grammar.error_index = token_index
                return grammar
            elif operation_flag == 's':
                state_number = int(operation[1:])
                analysis_stack.append(state_number)
                token_index += 1
                symbol_stack.append(token.text)
            elif operation_flag == 'r':
                statement_index = int(operation[1:]) - 1
                reduce_sum = self.__reduce_symbol_sum[statement_index]
                for _ in range(reduce_sum):
                    analysis_stack.pop()
                current_state = analysis_stack[-1]
                current_non_terminal_index = self.__reduce_to_non_terminal_index[statement_index]
                goto_next_state = self.__goto_table.get(current_state, {}).get(current_non_terminal_index, -1)
                if goto_next_state == -1:
                    raise ValueError('Invalid goto action: state={}, non-terminal={}'.format(current_state, current_non_terminal_index))
                analysis_stack.append(goto_next_state)
                if statement_index in self.__node_table:
                    temp_grammar_tuple_list = []
                    real_temp_grammar_tuple_list = []
                    for _ in range(reduce_sum):
                        temp_grammar_tuple_list.insert(0, symbol_stack.pop())
                    for i in self.__node_table[statement_index]:
                        if i == '@':
                            real_temp_grammar_tuple_list.append(statement_index)
                        else:
                            real_i = int(i[1:])
                            if i[0] == 'u':
                                real_temp_grammar_tuple_list += temp_grammar_tuple_list[real_i]
                            elif i[0] == 'p':
                                real_temp_grammar_tuple_list.append(temp_grammar_tuple_list[real_i])
                            else:
                                ValueError('Invalid node type: node={}'.format(i))
                    symbol_stack.append(tuple(real_temp_grammar_tuple_list))
                elif statement_index in [1, 2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13, 15, 18, 19, 20]:
                    temp_grammar_tuple_list = []
                    for _ in range(reduce_sum):
                        temp_grammar_tuple_list.insert(0, symbol_stack.pop())
                    temp_grammar_tuple_list.insert(0, statement_index)
                    symbol_stack.append(tuple(temp_grammar_tuple_list))
                else:
                    raise ValueError('Invalid reduce number: reduce={}'.format(statement_index))
            elif operation_flag == 'a':
                grammar.grammar_tree = symbol_stack[0]
                return grammar
            else:
                raise ValueError('Invalid action: action={}'.format(operation))
        raise RuntimeError('Analyzer unusual exit.')
